<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TO DO LIST</title>
    <link rel="stylesheet" href="../static/style.css">
</head>
<body>
    <header class="hero">
        <h1 id="greeting">Hello World</h1>
        <p id="subtext">TO DO LIST</p>
    </header>    

    <div class="user-info"> 
        {% if user %}
            <span>{{ user.name }}</span>
            <a href="/logout"><button>Logout</button></a>
        {% endif %}
        {% if not user %}
            <a href="/login"><button>Login</button></a>
            <a href="/register"><button>Register</button></a>
        {% endif %}
    </div>
    {% if user %}
             <a href="/add_task" class="add-task-btn">+ Add New Task</a>
    {% endif %}
    

<div class="tasks-container">
    {% for task in tasks %}
    <div class="task-card {{ 'purple' if loop.index is even else 'yellow' }}">
        <div class="task-header">
            <h3 class="task-title">{{ task.title }}</h3>
            <p class="task-deadline">
                {% if task.deadline %}
                    Due: {{ task.deadline.strftime('%Y-%m-%d %H:%M') }}
                {% endif %}
            </p>
        </div>

        {% if task.description %}
        <p class="task-desc">{{ task.description }}</p>
        {% endif %}

        <div class="task-actions">
            <button type="button" class="edit-btn" onclick="editTask({{ task.id }})">
                ‚úèÔ∏è Edit
            </button>
            <form method="post" action="/tasks/{{ task.id }}/delete" class="inline-form">
                <button type="submit" class="delete-btn">üóëÔ∏è Delete</button>
            </form>
        </div>
    </div>
    {% endfor %}
</div>
{%if not user%}
<div id="chatbot-container">
    <div id="chatbot-header" onclick="toggleChatbot()">
        üí¨ AI Chat
    </div>
    <div id="chatbot-body" style="display:none;">
        <div id="chatbot-messages"></div>
        <div id="chatbot-input-container">
            <input type="text" id="chatbot-input" placeholder="Type a message..." 
                   onkeypress="if(event.key==='Enter'){sendMessage();}">
            <span id="chatbot-send-icon" onclick="sendMessage()">‚û§</span>
        </div>
    </div>
</div>
<div id="news-widget" class="news-widget">
  <div id="news-bg" class="news-bg"></div>
  <h2 class="news-title">üì∞ Tin t·ª©c m·ªõi nh·∫•t v·ªÅ AI</h2>
  <div id="news-container" class="news-container"></div>
</div>
{%endif%}
{%if user%}
<div id="chatbot-container">
    <div id="chatbot-header" onclick="toggleChatbot()">
        üí¨ AI Chat @
    </div>
    <div id="chatbot-body" style="display:none;">
        <div id="chatbot-messages"></div>
        <div id="chatbot-input-container">
            <input type="text" id="chatbot-input" placeholder="Type a message..." 
                   onkeypress="if(event.key==='Enter'){sendMessagefromUser();}">
            <span id="chatbot-send-icon" onclick="sendMessagefromUser()">‚û§</span>
        </div>
    </div>
</div>
{%endif%}

   

    <script>
         function getGreetingParts(date = new Date()) {
  const h = date.getHours();
  if (h >= 5 && h < 12)   // Morning until 11:59 AM
      return { text: "Good Morning",  emoji: "", sub: "Ch√∫c b·∫°n c√≥ m·ªôt bu·ªïi s√°ng th·∫≠t b√πng l·ªï !!!!" };
  if (h >= 12 && h < 16)  // 12:00 PM - 3:59 PM
      return { text: "Good Afternoon", emoji: "", sub: "N·∫øu chi·ªÅu bu·ªìn ng·ªß th√¨ h√£y l√†m m·ªôt t√°ch cafe nh√© !!!" };
  if (h >= 16 && h < 20)  // 4:00 PM - 7:59 PM
      return { text: "Good Evening",   emoji: "", sub: "T·ªëi l√† l√∫c th√≠ch h·ª£p ƒë·ªÉ check l·∫°i todolist" };
  return { text: "Good Night", emoji: "", sub: "Ng·ªß Th√¥iiiiiiiiiiiiiiii" };
}

function updateGreeting() {
  const { text, emoji, sub } = getGreetingParts();
  document.getElementById("greeting").innerHTML = `${emoji} ${text}`;
  document.getElementById("subtext").innerText = sub;
}


  // Run immediately on page load
  document.addEventListener("DOMContentLoaded", () => {
    updateGreeting();
    setInterval(updateGreeting, 60_000); // update every 1 minute
  });
    function editTask(taskId){
        const newTitle = prompt("Edit Task");
        if(newTitle){
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/tasks/${taskId}/update`;
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'title';
            input.value = newTitle;
            form.appendChild(input);
            document.body.appendChild(form);
            form.submit();
        }
    }
    function deleteTask(taskId){
         
    }
   function toggleChatbot(){
    const body = document.getElementById('chatbot-body');
    body.style.display = (body.style.display === 'none') ? 'flex' : 'none';
}

async function sendMessage(){
    const input = document.getElementById('chatbot-input');
    const messages = document.getElementById('chatbot-messages');
    const text = input.value.trim();
    if(!text) return;

    const userDiv = document.createElement('div');
    userDiv.classList.add('message','user');
    userDiv.textContent = text;
    messages.appendChild(userDiv);
    input.value = '';
    messages.scrollTop = messages.scrollHeight;

    const botDiv = document.createElement('div');
    botDiv.classList.add('message','bot');
    botDiv.textContent = "Typing...";
    messages.appendChild(botDiv);
    await new Promise(r => setTimeout(r, 50)); 
    messages.scrollTop = messages.scrollHeight;


    try {
        const res = await fetch("http://127.0.0.1:8000/chat", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({message: text})
        });
        const data = await res.json();
        botDiv.textContent = data.reply;
        messages.scrollTop = messages.scrollHeight;
    } catch(err){
        botDiv.textContent = "Error connecting to AI.";
    }
}
async function sendMessagefromUser() {
    const input = document.getElementById('chatbot-input');
    const messages = document.getElementById('chatbot-messages');
    const text = input.value.trim(); // Bi·∫øn c·ªßa b·∫°n t√™n l√† 'text'
    if (!text) return;

    // Hi·ªÉn th·ªã tin nh·∫Øn c·ªßa user
    const userDiv = document.createElement('div');
    userDiv.classList.add('message', 'user');
    userDiv.textContent = text;
    messages.appendChild(userDiv);
    input.value = '';
    messages.scrollTop = messages.scrollHeight;

    // Hi·ªÉn th·ªã "Typing..."
    const botDiv = document.createElement('div');
    botDiv.classList.add('message', 'bot');
    botDiv.textContent = "Typing...";
    messages.appendChild(botDiv);
    await new Promise(r => setTimeout(r, 50));
    messages.scrollTop = messages.scrollHeight;

    // S·ª≠ d·ª•ng try...catch ƒë·ªÉ g·ªçi API
    try {
        const response = await fetch('http://localhost:8000/chat_with_user', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            // S·ª¨A L·ªñI 1: D√πng bi·∫øn 'text' thay v√¨ 'userMessage'
            body: JSON.stringify({ message: text }),
            
            // D√≤ng n√†y c·ªßa b·∫°n ƒë√£ CH√çNH X√ÅC
            credentials: 'include'
        });

        if (!response.ok) {
             // B√°o l·ªói n·∫øu server tr·∫£ v·ªÅ 4xx, 5xx
            throw new Error(`HTTP error! Status: ${response.status}`);
        }

        const data = await response.json();
        botDiv.textContent = data.reply; // C·∫≠p nh·∫≠t tin nh·∫Øn c·ªßa bot
        
    } catch (error) {
        // S·ª¨A L·ªñI 2: X·ª≠ l√Ω l·ªói ƒë√∫ng c√°ch
        console.error('Error fetching chat:', error); // Ghi log l·ªói ra console
        botDiv.textContent = "Error connecting to AI.";
    }

    // Lu√¥n cu·ªôn xu·ªëng cu·ªëi sau khi c√≥ k·∫øt qu·∫£ ho·∫∑c l·ªói
    messages.scrollTop = messages.scrollHeight;
}
async function loadNews() {
  const container = document.getElementById('news-container');
  const bg = document.getElementById('news-bg');
  container.innerHTML = "<p>ƒêang t·∫£i tin t·ª©c m·ªõi nh·∫•t...</p>";

  try {
    const res = await fetch("https://newsdata.io/api/1/latest?apikey=pub_d8a6b56ba719427eb8654e803985f053&q=AI&language=vi,en");
    const data = await res.json();

    container.innerHTML = "";

    const results = data.results || [];
    if (results.length === 0) {
      container.innerHTML = "<p>Kh√¥ng c√≥ tin t·ª©c n√†o ƒë∆∞·ª£c t√¨m th·∫•y.</p>";
      return;
    }

    // üñº L·∫•y ·∫£nh ƒë·∫ßu ti√™n l√†m n·ªÅn widget
    const firstImage = results.find(a => a.image_url)?.image_url;
    bg.style.backgroundImage = `url('${firstImage || "https://via.placeholder.com/1200x700?text=AI+News"}')`;

    // Hi·ªÉn th·ªã tin
    results.slice(0, 6).forEach(article => {
      const div = document.createElement("div");
      div.className = "news-item";

      const imageUrl = article.image_url || "https://via.placeholder.com/400x250?text=AI+News";

      div.innerHTML = `
        <div class="news-image-wrapper">
          <img src="${imageUrl}" alt="news image" class="news-image" />
        </div>
        <div class="news-content">
          <a href="${article.link}" target="_blank">${article.title || "Kh√¥ng c√≥ ti√™u ƒë·ªÅ"}</a>
          <p class="news-desc">${article.description ? article.description.slice(0, 90) + "..." : "Kh√¥ng c√≥ m√¥ t·∫£."}</p>
          <p class="news-source">${article.source_id ? "Ngu·ªìn: " + article.source_id : ""}</p>
        </div>
      `;
      container.appendChild(div);
    });

  } catch (err) {
    console.error(err);
    container.innerHTML = "<p>L·ªói khi t·∫£i tin t·ª©c.</p>";
  }
}

document.addEventListener("DOMContentLoaded", loadNews);

window.addEventListener("load", () => {
    fetch("/reload_event", { method: "POST" });
});

</script>
</body>
</html>
